//
//  RadiusLocationViewController.swift
//  Radius
//
//  Created by Kassandra Capretta on 1/22/20.
//  Copyright Â© 2020 Kassandra Capretta. All rights reserved.
//

import UIKit
import CoreLocation
import MapKit

class RadiusLocationViewController: UIViewController, CLLocationManagerDelegate, MKMapViewDelegate {

    @IBOutlet weak var mapView: MKMapView!
    
    var locationManager : CLLocationManager = CLLocationManager()
    
    func locationManager(_ manager: CLLocationManager, didChangeAuthorization status: CLAuthorizationStatus) {
      mapView.showsUserLocation = (status == .authorizedAlways)
    }
    
    func locationManager(_ manager: CLLocationManager, didEnterRegion region: CLRegion) {
             showAlert(withTitle: "You've entered \(region.identifier)", message: "Happy hopping!")
    }
    
    func locationManager(_ manager: CLLocationManager, didExitRegion region: CLRegion) {
           showAlert(withTitle: "You've exited \(region.identifier)", message: "")
    }
    
    func region(with geotification: Geotification) -> CLCircularRegion {
      // 1
      let region = CLCircularRegion(center: geotification.coordinate,
        radius: geotification.radius,
        identifier: geotification.identifier)
      // 2
      region.notifyOnEntry = (geotification.eventType == .onEntry)
      region.notifyOnExit = !region.notifyOnEntry
      return region
    }

    func startMonitoring(geotification: Geotification) {
      // 1
      if !CLLocationManager.isMonitoringAvailable(for: CLCircularRegion.self) {
        showAlert(withTitle:"Error", message: "Geofencing is not supported on this device!")
        return
      }
      // 2
      if CLLocationManager.authorizationStatus() != .authorizedAlways {
        let message = """
          Your geotification is saved but will only be activated once you grant
          Geotify permission to access the device location.
          """
        showAlert(withTitle:"Warning", message: message)
      }
      // 3
      let fenceRegion = region(with: geotification)
      // 4
      locationManager.startMonitoring(for: fenceRegion)
    }
    
    func stopMonitoring(geotification: Geotification) {
      for region in locationManager.monitoredRegions {
        guard let circularRegion = region as? CLCircularRegion,
          circularRegion.identifier == geotification.identifier else { continue }
        locationManager.stopMonitoring(for: circularRegion)
      }
    }
    
    override func viewDidLoad() {
        super.viewDidLoad()
        
        setupData()
        mapView.userTrackingMode = .follow
        mapView.delegate = self
        mapView.showsUserLocation = true

        self.locationManager.requestAlwaysAuthorization()
        self.locationManager.delegate = self as CLLocationManagerDelegate
        
        //Zoom to user location
        if let userLocation = locationManager.location?.coordinate {
            let viewRegion = MKCoordinateRegion(center: userLocation, latitudinalMeters: 200, longitudinalMeters: 200)
            mapView.setRegion(viewRegion, animated: false)
        }
        
        func locationManager(_ manager: CLLocationManager, didChangeAuthorization status: CLAuthorizationStatus) {
          if (status == CLAuthorizationStatus.authorizedAlways) {
          }
        }
        
    }
    
    func setupData() {
        // 1. check if system can monitor regions
        if CLLocationManager.isMonitoringAvailable(for: CLCircularRegion.self) {
     
            // 2. region data
            let title = "Marina Bar Hop"
            let coordinate = CLLocationCoordinate2DMake(33.97823607957177, -118.43823725357653)
            let regionRadius = 300.0
     
            // 3. setup region
            let region = CLCircularRegion(center: CLLocationCoordinate2D(latitude: coordinate.latitude,
                longitude: coordinate.longitude), radius: regionRadius, identifier: title)
            locationManager.startMonitoring(for: region)
     
            // 4. setup annotation
            let restaurantAnnotation = MKPointAnnotation()
            restaurantAnnotation.coordinate = coordinate;
            restaurantAnnotation.title = "\(title)";
            mapView.addAnnotation(restaurantAnnotation)
     
            // 5. setup circle
            let circle = MKCircle(center: coordinate, radius: regionRadius)
            mapView.addOverlay(circle)
        }
        else {
            print("System can't track regions")
        }
    }
     
    // 6. draw circle
    func mapView(_ mapView: MKMapView, rendererFor overlay: MKOverlay) -> MKOverlayRenderer {
        let circleRenderer = MKCircleRenderer(overlay: overlay)
        circleRenderer.strokeColor = UIColor.red
        circleRenderer.lineWidth = 1.0
        return circleRenderer
    }
    
}
